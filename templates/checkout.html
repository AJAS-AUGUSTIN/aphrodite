{% extends 'base.html' %}

{% load static %}

{% block content %}
<!-- ============================ COMPONENT 1 ================================= -->
<div class="row">
	<aside class="col-lg-6">
<a href="{% url 'add_address_checkout' %}" class="btn btn-dark" style="margin-left: 5%; margin-top: 5%;">Add Address</a>

<form action="{% url 'place_order' %}" method="post">
{% csrf_token %}
<div style="outline: 2px dashed black; margin-left: 10px;margin-top: 10px;">
	{% for add in address %}
	<div class="container">
	<div class="ex1">

		<!-- <select class="form-select" aria-label="Default select example">
			<option selected>Select Address</option>
			<option value="1">One</option>
			<option value="2">Two</option>
			<option value="3">Three</option>
		  </select> -->

		<input class="form-check-input" type="radio"  name="address" id="address" style="margin-left: 10px;" value="{{add.id}}">
		<label class="form-check-label" for="flexRadioDefault1"  style="margin-left: 50px;">
			<a href="{% url 'editaddress_checkout' id=add.id %}" class="btn btn-primary " style="margin-left: 750px;" >Edit</a>
			<p>{{add.first_name}}  {{add.last_name}}</p>
			<p>{{add.address_line_1}}</p>
			<p>{{add.address_line_2}}</p>
			<p>{{add.phone}}</p>
			<!-- <p>{{add.email}}</p> -->
			<p>{{add.phone_number}}</p>
			<p>{{add.city}}</p>
			<!-- <p>{{add.state}}</p>
			<p>{{add.country}}</p> -->
			<p>{{add.pincode}}</p>
		</label>
	  </div>
	</div>  
{% endfor %}
</div>
<div class="form-check p-5">
	<h2>Payment</h2>
	<input style="margin-left: 10px;" class="form-check-input" type="checkbox" name="cash" id="cash" value="cash on delivery" >
	<button class="btn btn-primary" name="cash" value="cash on delivery" style="width: 88%;margin-bottom: 3%;"><label style="margin-left: 30px;" class="form-check-label" for="flexRadioDefault1">
	  Cash on Delivery
	</label></button>

	<div id="paypal-button-container"></div>

    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>

	<!-- razorpay
	<input type="hidden" custom="Hidden Element" name="hidden">
	
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->

</div>


	</aside> <!-- col.// -->
	<aside class="col-lg-6">

		<div class="card">
		<div class="card-body">
			<!-- table -->
			<table class="table table-borderless table-shopping-cart">
				<thead class="text-muted">
				<tr class="small text-uppercase">
				  <th scope="col">Product</th>
				  <th scope="col" width="120">Quantity</th>
				  <th scope="col" width="120">Price</th>
				</tr>
				</thead>
				<tbody>
					{% for cart_item in cart_items %}
				<tr>
					<td>
						<figure class="itemside align-items-center">
							<div class="aside"><img src="{{ cart_item.product.image1.url }}" class="img-sm"></div>
							<figcaption class="info">
								<a href="" class="title text-dark">{{cart_item.product.brand}} {{cart_item.product.product_name}}</a>
								<p class="text-muted small"><br> Brand: {{cart_item.product.brand}}</p>
							</figcaption>
						</figure>
					</td>
					<td> 
						<!-- col.// -->
								<label for="">{{cart_item.quantity}}</label>
					</td>
					<td> 
						<div class="price-wrap"> 
							<var class="price">₹{{ cart_item.sub_total }}</var> 
							<small class="text-muted">₹{{cart_item.product.product_discount_price}}</small> 
						</div> <!-- price-wrap .// -->
					</td>
				</tr>
				{% endfor %}
				</tbody>
				</table>
			<button type="submit" value="submit" class="btn btn-dark btn-block">Place Order</button>
			<a href="{% url 'home' %}" class="btn btn-light btn-block">Continue Shopping</a>
			<!-- <input type="submit" value="Submit"> -->
</form>
		</div> <!-- card-body.// -->
		</div> <!-- card.// -->

</aside> <!-- col.// -->

</div> <!-- row.// -->

<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .//  -->
</section>


<!-- ========================= SECTION CONTENT END// ========================= -->


<!-- paypal script -->

<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* creating uuid  */

function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}

	var amount = '{{ grand_total }}'
	var url = "{% url 'paypal_payment' %}"
	var csrftoken = getCookie('csrftoken');
	var orderID = uuidv4()	
	var payment_methods = "PayPal"
	var address_id = document.querySelector('[name="address"]').value;
	var redirecting_url = "{% url 'paypal_payment_success' %}"
	var error_redirecting_url = "{% url 'payment_error' %}"
	
	// Render the PayPal button into #paypal-button-container
	paypal.Buttons({

		// Set up the transaction
		createOrder: function(data, actions) {
			return actions.order.create({
				purchase_units: [{
					amount: {
						value: amount,
					}
				}]
			});
		},

		// Finalize the transaction
		onApprove: function(data, actions) {
			return actions.order.capture().then(function(orderData) {
				// Successful capture! For demo purposes:
				console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
				var transaction = orderData.purchase_units[0].payments.captures[0];
				// alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');
				sendData();
				function sendData(){
					fetch(url, {
						method:"POST",
						headers: {
							"Content-type":"application/json",
							"X-CSRFToken":csrftoken,
						},
						body: JSON.stringify({
							orderID: orderID,
							transID: orderData.id,
							payment_methods : payment_methods,
							status : orderData.status,
							address_id : address_id,
                    		grand_total :  amount,
						}),
					})
					// .then(response => response.json())
					// .then(data => console.log(data));
					.then(response => response.json())
                	.then(data => {
                  	console.log(data);
                  	console.log("success")
                  	window.location.href = redirecting_url + '?order_id='+data.new_order_id+'&trans_id='+data.transID;

                })
                .catch((error) => {
                  window.location.href = error_redirecting_url;
                });
				}
				// Replace the above to show a success message within this page, e.g.
				// const element = document.getElementById('paypal-button-container');
				// element.innerHTML = '';
				// element.innerHTML = '<h3>Thank you for your payment!</h3>';
				// Or go to another URL:  actions.redirect('thank_you.html');
			});
		}


	}).render('#paypal-button-container');

</script>


<!-- <script>
	function razor_function(grand_total,currency,order_id){

		var options = {
			"key":'rzp_test_EBo2ZDIjBvXvjr', // Enter the Test API Key ID generated from Dashboard → Settings → API Keys
			"amount":grand_total, // Amount is in currency subunits. Hence, 29935 refers to 29935 paise or ₹299.35.
			"currency": currency,// You can accept international payments by changing the currency code. Contact our Support Team to enable International for your account
			"order_id": order_id,// Replace with the order_id generated by you in the backend.
			name="WatchKart",
			description="Test Transaction",
			"handler": function(response){
				alert(response.razorpay_payment_id);
				alert(response.razorpay_order_id);
				alert(response.razorpay_signature);

				document.getElementById("payment_id_generated").value = razorpay_order_id;
				$('#checkout_form').submit()
			},
		};
		var rzp1 = new Razorpay(options);
		rzp1.on('payment.failed',function (response){
			window.location.href = error_redirecting_url
		});
		document.getElementById('rzp-button1').onclick = function(e){

		}
		rzp1.open();
		e.preventDefault();
	}



</script> -->


 <style>
	 div.ex1 {
  background-color: lightblue;
  width: 910px;
  height: 150px;
  overflow: scroll;
}
 </style>
</body>
</html>

{% endblock %}